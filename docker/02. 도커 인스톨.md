도커 인스톨
===========

### 요구사항 

* 64비트 아키텍처가 실행되어야 함 
* 리눅스 3.8 이상 버전이 실행되어야 함. 
* 커널은 Device-Mapper, AUFS, VFS, BTRFS 중 하나를 지원해야 한다. 보통 기본 Device-Mapper를 사용한다. 
* cgroups와 namespace 커널 기능은 지원되어야 하고 활성화되어 있어야 한다. 


### 우분투에 인스톨 

먼저 도커가 실행될 수 있는 최신 리눅스 커널인지 체크한다. 

```
$ uname -a
```

커널 버전이 낮다면 커널을 업그레이드 한다.

```
$ sudo apt-get update
$ sudo apt-get install linux-headers-3.8.0-27-generic linux-image-3.8.0-27-generic linux-headers-3.8.0-27
```

그리고 나서 새로운 커널을 로드하기 위해 Grup 부트로더를 업데이트 한다.

```
$ sudo update-grub
```

인스톨 후에 새로운 3.8 커널을 사용하기 위해 호스트를 리부트 해야 한다. 

```
$ sudo reboot
```

**디바이스 맵퍼 체크**

디바이스 맵퍼 스토리지 드라이버를 사용해보기로 하자. 디바이스 맵퍼 프레임워크는 2.6.9 이후의 리눅스 커널에 포함되어 있으며 상위 레벨 가상 디바이스에서 블럭 디바이스를 매핑하기 위한 방법을 제공한다. 다중 가상 디바이스, 도커 이미지 내의 레이어를 파일 시스템에 저장하기 위해 thin-provisioning 이라는 개념을 지원한다. 따라서 도커에 필요한 스토리지를 완벽하게 제공한다. 

```
$ ls -l /sys/class/misc/device-mapper
```

```
$ sudo grep device-mapper /proc/devices
```

존재하지 않으면 dm_mod 모듈을 로드해보자 

```
$ sudo modprobe dm_mod
```

cgroup와 namespace 이 두가지는 리눅스 커널 2.6부터 지원됐다. 이 두가지 모두 커널 2.6.3 릴리즈 이후부터 상대적으로 버그도 덜하고 잘 지원한다. 

**도커 설치**

도커 API Repository를 추가하고 자동으로 호스트에 Repository GPG가 추가 됐는지 확인해보자 

```
$ sudo sh -c "echo deb https://get.docker.io/ubuntu docker main > /etc/apt/sources.list.d/docker.list"
```

먼저 curl 커맨드가 설치되어 있는지 확인해야 한다. 

```
$ whereis curl
```

curl이 없으면 설치한다. 

```
sudo apt-get -y install curl 
```

다음으로 도커 리포지터리의 GPG 키를 추가해야 한다. 

```
$ curl -s https://get.docker.io/gpg | sudo apt-get add -
```

이제 APT 소스를 업데이트 한다. 

```
$ sudo apt-get update
```

도커 패키지 자체를 인스톨 할 수 있다. 

```
$ sudo apt-get install lxc-docker
```

잘 설치되었는지 커맨드를 실행해보자

```
$ sudo docker info
```

**도커와 UFW**

우분투에서 Uncomplicated Firewall을 사용한다면 도커를 사용할 때 약간의 수정이 필요하다. 도커는 컨테이너의 네트워크를 관리하기 위해 네트워크 브릿지를 사용한다. 기본적으로 UFW는 모든 패킷 포워드를 드롭한다. 도커가 제대로 동작하도록 하기 위해서는 UFW에서 포워딩을 활성화시켜야 한다. /etc/default/ufw 파일을 수정해서 이 작업을 하면 된다. 

~~DEFAULT_FORWARD_POLICY="DROP"~~

DEFAULT_FORWARD_POLICY="ACCEPT"


UFW의 업데이트를 저장하고 다시 로드한다.

```
$ sudo ufw reload
```
