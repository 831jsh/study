도커 이미지와 리포지터리 작업하기
=================================


도커 이미지는 각각의 레이어로 구성된 파일 시스템으로 되어 있다. 베이스는 부트 파일 시스템인 bootfs이며 이러한 구조는 우리가 흔히 사용하는 일반적인 리눅스/유닉스 부트 파일 시스템과 비슷하다. 도커 사용자는 부트 파일 시스템을 액세스 할 일이 거의 없다. 실제로 컨테이너가 부팅되면 컨테이너는 메모리로 이동하고 부트 파일 시스템의 마운트는 해제되며 따라서 initrd 디스크 이미지가 확보하여 사용하고 있는 RAM 역시 해제된다.

지금까지는 일반적인 리눅스 가상화 스택과 거의 비슷하다. 도커에서 살펴봐야 할 그 다음 레이어는 루트 파일시스템이며 rootfs이다. 이 rootfs는 부트 파일 시스템 위에 존재한다. 이 rootfs는 운영체제 중 하나가 될 수 있다. 예를 들어 데비안이나 우분투 파일 시스템이 이에 해당한다. 

일반적인 리눅스 부트에서는 루트 파일 시스템은 읽기-전용으로 마운트되고 부팅된 후에 읽기-쓰기로 바뀐다. 그리고 통합 체크(integrity check)가 실행된다. 그러나 도커에서의 루트 파일 시스템은 읽기-전용 모드로 계속 유지되며 이 루트 파일 시스템에 읽기-전용 파일 시스템을 추가하여 유니언 마운트가 갖는 장점을 갖게된다. 유니언 마운트는 한 번에 여러 파일 시스템을 마운트하지만 마치 하나의 파일 시스템처럼 보이도록 하는 마운트를 의미한다. 유니언 마운트는 상위에 각각의 파일 시스템을 오버레이하여 결과적으로 사용자가 인식하기에는 하나의 내부 파일 시스템을 사용하도록 해주며 이 파일 시스템에는 각각의 파일 시스템의 일부 혹은 전체 파일들과 서브디렉터리 모두 포함할 수도 있다. 

도커는 이러한 파일 시스템 이미지 각각을 호출한다. 이미지는 다른 이미지의 위에 레이어된다. 아래에 존재하는 이미지를 부모 이미지라고 하며 베이스 이미지라고 하는 마지막 이미지가 위치하고 있는 이미지 스택의 끝에 도달할 때까지 각 레이어를 탐색할 수 있다. 도커는 읽기-쓰기 파일 시스템을 맨 상위에 마운트한다. 이 파일 시스템에서 도커 컨테이너를 실행하도록 하는 프로세스가 존재한다. 

도커가 맨 처음 컨테이너를 시작할 때 초기 읽기-쓰기 레이어는 비어 있다. 변경 사항이 발생되면 그 변경 사항은 이 읽기-쓰기 레이어에 적용된다. 예를 들어 파일을 변경하려면 그 파일은 아래에 존재하는 읽기-전용 레이어로부터 읽기-쓰기 레이어로 복사된다. 파일의 읽기-전용 버전은 사라지는 것이 아니라 계속 존재하지만 이 순간에는 복사본 아래에 숨겨져 있다. 

이러한 패턴을 일반적으로 cow라고 하며 도커를 강력하게 만들어 준 기능 중 하나다. 각 읽기-전용 이미지 레이어는 읽기-전용이다. 이 이미지는 절대 변경할 수 없다. 컨테이너가 생성될 때 도커는 이미지의 스택으로부터 빌드되며 맨 위에읽기-쓰기 레이어를 추가한다. 이 레이어는 아래의 있는 이미지 레이어의 정보를 가져온다. 이 정보는 여러 설정 데이터 컨테이너의 상태 등이다. 이전 장에서 설명했듯이 컨테이너는 변경될 수 있으며 상태를 갖고 있으며 컨테이너는 시작하거나 실행 중에 중지될 수 있다. 이미지-레이어 프레임워크는 이미지를 빠르게 빌드할 수 있도록 해주며 애플리케이션과 서비스를 가진 컨테이너를 빠르게 실행할 수 있도록 해준다. 
